# lobe-chat

## Installation

Reference Documentation:

- <https://lobehub.com/zh/docs/self-hosting/server-database/docker-compose>

1. Refer to [Quick Start](https://lobehub.com/zh/docs/self-hosting/server-database/docker-compose). First, use Docker Compose to deploy and understand the purpose of each component and the use of environment variables.
2. After analysis, draw preliminary conclusions:
   1. `network-service` (based on Alpine) is not needed, as its purpose is similar to Ingress.
   2. `minio` is needed (I tried using QNAP's object storage but failed), but it will be used as a separate service deployed with Helm in a separate namespace.
3. Based on the above conclusions, delete the configurations related to `network-service` and `minio`, and modify the `docker-compose.yml` file. The modified file is [here](./examples/docker-compose-remove-minio-and-network-service.yml.example).
4. Use `kompose` to convert the above file into Kubernetes resource files. Obtain:
   1. lobe
      1. deploy
      2. service
   2. casdoor
      1. deploy
      2. service
      3. cm (Casdoor configuration file generated by Quick Start)
   3. pgvector
      1. deploy
      2. service
      3. PVC

### Helm Installation of MinIO

> Here, helm-dashboard is used for installation.

The final Helm values configuration is as follows:

```yaml
deploymentUpdate:
    type: Recreate
ingress:
    annotations:
        tailscale.com/experimental-forward-cluster-traffic-via-ingress: "true"
        tailscale.com/proxy-group: ingress-proxies
    enabled: true
    hosts:
        - minio
    ingressClassName: tailscale
    tls:
        - hosts:
            - minio
mode: standalone
persistence:
    size: 100Gi
replicas: 1
```

Explanation:

- `deploymentUpdate`: Use the `Recreate` update strategy to avoid pods being stuck during PVC upgrades due to RWO.
- `ingress`: Use Tailscale Ingress and `forward-cluster-traffic-via-ingress` (because the lobe service will use it later).
- `mode: standalone`: Use single-node mode. Distributed mode is not considered for now.
- `persistence`: Use a 100Gi PVC.
- `replicas`: Set to 1 (default is 16).

> üìù**Notes**:
>
> Managed by ArgoCD since February 16, 2025.

### Additional Manual Configuration for MinIO

> üêæ**Warning:**
>
> The "Quick Start" script has already created these, but since we are not using Docker Compose for deployment, manual creation is required.

1. Create bucket: lobe
2. Modify the anonymous access permissions of bucket: lobe to allow read (otherwise, the lobe frontend page cannot access. TODO: Should be able to set `S3_SET_ACL: "0"` to avoid anonymous read).
   1. Prefix: `/`
   2. Access: `readonly`
3. Create AKSK

### Modify Kubernetes Resource Files

#### casdoor

- Modify `redirectUris` in the `cm` file to the official address: `https://lobe.west-beta.ts.net...`
- Modify `origin: https://casdoor.west-beta.ts.net` in the `env` of the `deploy` file (because it needs to be accessed from the browser side).
- Add `casdoor-ingress.yaml` to create Tailscale Ingress. Add `forward-cluster-traffic-via-ingress` because it also needs to be accessed within the cluster.
- Add `casdoor-externalservice.yaml` because it also needs to be accessed within the cluster.

#### pgvector

- Expand PVC size to 10Gi
- Add `rm-lost-found` initContainer to perform the operation: `rm -rf /var/lib/postgresql/data/lost+found` (when starting pgvector, if the `/var/lib/postgresql/data/` folder is not empty, specifically the `lost+found` folder exists, it cannot start, so it needs to be deleted)

#### lobe

- Modify `env` in the `deploy` file:
  - `APP_URL: https://lobe.west-beta.ts.net`
  - `AUTH_CASDOOR_ISSUER: https://casdoor.west-beta.ts.net`
  - `NEXTAUTH_URL: https://lobe.west-beta.ts.net/api/auth` (change `AUTH_URL` to `NEXTAUTH_URL`)
  - `S3_ENDPOINT: https://minio.west-beta.ts.net`
  - `S3_PUBLIC_DOMAIN: https://minio.west-beta.ts.net` (different for public clouds, this should be your own domain)
  - `OLLAMA_PROXY_URL: http://ollama.ollama:11434`
  - `DEFAULT_FILES_CONFIG: embedding_model=embedding_model=zhipu/embedding-3`
  - Similar to casdoor, also create ingress and externalservice

> üìù**Notes**:
>
> For Ollama, it can be:
> `DEFAULT_FILES_CONFIG: embedding_model=ollama/snowflake-arctic-embed2:latest`
> üìöÔ∏èReference Documentation: <https://ollama.com/search?c=embedding>

### Deployment

1. Create namespace: `kubectl create ns lobe-chat`
2. Deploy Kubernetes resource files to the cluster: `kubectl apply -f . -n lobe-chat`

> üìù**Notes**:
>
> Managed by ArgoCD since February 16, 2025.

#### February 14, 2025 Update

- Remove all sensitive information, including:
  - `docker-compose.yml` and `casdoor-cm0-configmap.yaml`: Only place examples in the repo, real files are in the Homelab Kubernetes cluster.
  - All sensitive information in ENV: Change to Secrets, Secrets are not stored in the repo, real files are in the Homelab Kubernetes cluster.
    - AUTH related
    - s3 related
    - AI API KEY related
    - DB related

#### February 16, 2025 Update

- MinIO managed by ArgoCD
- Ollama managed by ArgoCD, and openwebui removed.

### üêæSpecial Attention

Emphasize again that lobe/casdoor/minio need to ensure that the domain name can be accessed both inside and outside the cluster. To achieve this, ensure:

- Create Ingress and add annotations:
  - `tailscale.com/experimental-forward-cluster-traffic-via-ingress: "true"`
- Create ExternalService

### Testing and Verification

1. Access MinIO console (via pod ip:9001)
2. Access Casdoor: <https://casdoor.west-beta.ts.net>
3. Access Lobe: <https://lobe.west-beta.ts.net>
4. Log in to Lobe (verify ["Authentication"](https://lobehub.com/zh/docs/self-hosting/environment-variables/auth) related services)
5. Chat using DeepSeek SaaS service (verify ["Model Provider"](https://lobehub.com/zh/docs/self-hosting/environment-variables/model-provider) related functions)
6. Chat using local Ollama model (verify if Ollama has started normally and Lobe is correctly configured)
7. Upload files (verify ["S3 Storage Service"](https://lobehub.com/zh/docs/self-hosting/environment-variables/s3) related configurations)
8. View files (verify `S3_PUBLIC_DOMAIN` and MinIO anonymous read-only configuration)
9. Vectorize files (verify `embedding_model` related configurations. Reference Documentation: [LobeChat Knowledge Base / File Upload ¬∑ LobeChat Docs ¬∑ LobeHub](https://lobehub.com/zh/docs/self-hosting/advanced/knowledge-base))
10. Chat based on knowledge base (verify the entire process above)

## TODO: Optimizations

- [ ] Voice reading function not available
- [ ] Should be able to set `S3_SET_ACL: "0"` to avoid anonymous read.
- [ ] MinIO should be able to set bucket and policy directly through Helm without manual creation.
- [x] Install plugins and persist (probably not needed? -- currently seems not needed)
- [x] Current embedding_model is not effective, choose a better-performing model later. (using `zhipu/embedding-3`)
- ~~Change to Helm chart~~
- [x] ArgoCD deployment
- [x] Remove sensitive information
- [x] Ollama image deployment (enable GPU/SHM)
- [x] MinIO ArgoCD deployment
